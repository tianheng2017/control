<?php

namespace app\admin\controller;

use app\admin\model\SystemAdmin;
use app\common\controller\AdminController;
use think\App;
use app\admin\model\{ Orders, Sales };

class Index extends AdminController
{

    /**
     * 后台主页
     * @return string
     * @throws \Exception
     */
    public function index()
    {
        return $this->fetch('', [
            'admin' => session('admin'),
        ]);
    }

    /**
     * 后台欢迎页
     * @return string
     * @throws \Exception
     */
    public function welcome()
    {
        $name = [
            'today_client_num'      =>  '今日对接客户数量',
            'yesterday_client_num'  =>  '昨日对接客户数量',
            'month_client_num'      =>  '月对接客户数量',
            'all_client_num'        =>  '总对接客户数量',
        ];
        $data = [
            'today_client_num'      =>  Sales::whereDay('create_time')->distinct(true)->field('name')->count(),
            'yesterday_client_num'  =>  Sales::whereDay('create_time', 'yesterday')->distinct(true)->field('name')->count(),
            'month_client_num'      =>  Sales::whereMonth('create_time')->distinct(true)->field('name')->count(),
            'all_client_num'        =>  Sales::distinct(true)->field('name')->count(),
        ];
        $this->assign('name', $name);
        $this->assign('data', $data);
        return $this->fetch();
    }

    /**
     * 修改密码
     * @return string
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\DbException
     * @throws \think\db\exception\ModelNotFoundException
     */
    public function editPassword()
    {
        $id = session('admin.id');
        $row = SystemAdmin::withoutField('password')->find($id);
        if ($row->isEmpty()) {
            $this->error('用户信息不存在');
        }
        if ($this->request->isAjax()) {
            $post = $this->request->post();
            $rule = [
                'password|登录密码'       => 'require',
                'password_again|确认密码' => 'require',
            ];
            $this->validate($post, $rule);
            if ($post['password'] != $post['password_again']) {
                $this->error('两次密码输入不一致');
            }
            try {
                $save = $row->save([
                    'password' => password($post['password']),
                ]);
            } catch (\Exception $e) {
                $this->error('保存失败');
            }
            if ($save) {
                $this->success('保存成功');
            } else {
                $this->error('保存失败');
            }
        }
        $this->assign('row', $row);
        return $this->fetch();
    }

}
